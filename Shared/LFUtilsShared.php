<?php
namespace Tellaw\LeadsFactoryBundle\Shared; use Tellaw\LeadsFactoryBundle\Entity\UserPreferences; class LFUtilsShared { public function updateListElements($spd5d3a1) { $sp8f0616 = json_decode($spd5d3a1, true); $sp821f0a = array(); $sp870836 = $sp8f0616['lists']; $spa5b0a7 = $sp8f0616['elements']; $sp11c2f6 = 0; if (count($spa5b0a7) > 0) { list($sp821f0a, $sp870836) = $this->sp55b1f9($spa5b0a7, $sp870836, $sp821f0a, $sp11c2f6, null); } $this->deleteOldChilds($sp821f0a, $sp870836); } private function sp55b1f9($spa5b0a7, $sp870836, $sp821f0a, $sp11c2f6, $sp19950a) { $spfab6f9 = $this->container->get('doctrine')->getManager(); foreach ($spa5b0a7 as $spbf1f67 => $spd7baf3) { if (array_key_exists('id', $spd7baf3)) { $sp56f784 = $spfab6f9->getRepository('TellawLeadsFactoryBundle:ReferenceListElement')->find($spd7baf3['id']); $sp56f784->setName($spd7baf3['name']); $sp56f784->setValue($spd7baf3['value']); $spfab6f9->flush(); $sp821f0a[$sp870836[$sp11c2f6]][$spd7baf3['id']] = true; } else { $sp56f784 = new ReferenceListElement(); $sp56f784->setName($spd7baf3['name']); $sp56f784->setValue($spd7baf3['value']); $spe81cc8 = $spfab6f9->getRepository('TellawLeadsFactoryBundle:ReferenceList')->find($sp870836[$sp11c2f6]); $sp56f784->setReferenceList($spe81cc8); if ($sp19950a != null) { $sp3adca2 = $spfab6f9->getRepository('TellawLeadsFactoryBundle:ReferenceListElement')->find($sp19950a); $sp56f784->setParent($sp3adca2); } $spfab6f9->persist($sp56f784); $spfab6f9->flush(); $sp821f0a[$sp870836[$sp11c2f6]][$sp56f784->getId()] = true; } $spb683d8 = $sp56f784->getId(); if (array_key_exists('childrens', $spd7baf3)) { if (count($spd7baf3['childrens']) > 0) { list($sp821f0a, $sp870836) = $this->sp55b1f9($spd7baf3['childrens'], $sp870836, $sp821f0a, $sp11c2f6 + 1, $spb683d8); } } } return array($sp821f0a, $sp870836); } public function deleteOldChilds($sp821f0a, $sp870836) { array_reverse($sp870836); $spfab6f9 = $this->container->get('doctrine')->getManager(); foreach ($sp870836 as $sp038d8b) { $sp5595a3 = 'SELECT id FROM `ReferenceListElement` WHERE referencelist_id = :listId'; $sp043d70 = $spfab6f9->getConnection()->prepare($sp5595a3); $sp043d70->bindValue('listId', $sp038d8b); $sp043d70->execute(); $sp401513 = $sp043d70->fetchAll(); foreach ($sp401513 as $sp3c24b2) { if (!array_key_exists($sp3c24b2['id'], $sp821f0a[$sp038d8b])) { $sp0ff49e = $this->container->get('doctrine')->getRepository('TellawLeadsFactoryBundle:ReferenceListElement')->find($sp3c24b2['id']); $spfab6f9 = $this->container->get('doctrine')->getManager(); $spfab6f9->remove($sp0ff49e); $spfab6f9->flush(); echo 'Delete : ' . $sp3c24b2['id'] . ' - '; } } } } public function getListOfLists($spd82b9b, $sp870836 = array()) { if (!in_array($spd82b9b, $sp870836)) { $sp870836[] = $spd82b9b; } $spd82b9b = $this->getLinkedLists($spd82b9b); if ($spd82b9b) { $sp870836[] = $spd82b9b; $sp870836 = $this->getListOfLists($spd82b9b, $sp870836); } return $sp870836; } public function getLinkedLists($spd82b9b) { $spfab6f9 = $this->container->get('doctrine')->getManager(); $sp5595a3 = 'SELECT referencelist_id FROM `ReferenceListElement` WHERE parent_id IN (SELECT id FROM `ReferenceListElement` WHERE referencelist_id = :listId ) GROUP BY referencelist_id'; $sp043d70 = $spfab6f9->getConnection()->prepare($sp5595a3); $sp043d70->bindValue('listId', $spd82b9b); $sp043d70->execute(); $sp401513 = $sp043d70->fetchAll(); if (count($sp401513) > 0) { $sp0bb1af = $sp401513[0]['referencelist_id']; return $sp0bb1af; } else { return false; } } public function getUserPreferences() { $spbce6f3 = $this->container->get('session'); if ($spbce6f3->has('user-preferences')) { return $spbce6f3->get('user-preferences'); } else { $sp2b8ebc = new UserPreferences(); $spbce6f3->set('user-preferences', $sp2b8ebc); $spbce6f3->save(); return $sp2b8ebc; } } public function setUserPreferences($sp2b8ebc) { $spbce6f3 = $this->container->get('session'); $spbce6f3->set('user-preferences', $sp2b8ebc); $spbce6f3->save(); } }