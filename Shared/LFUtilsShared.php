<?php
namespace Tellaw\LeadsFactoryBundle\Shared; use Tellaw\LeadsFactoryBundle\Entity\UserPreferences; class LFUtilsShared { public function updateListElements($sp9d6191) { $sp705ab5 = json_decode($sp9d6191, true); $sp3b6396 = array(); $sp3a0fda = $sp705ab5['lists']; $sp9a47a1 = $sp705ab5['elements']; $sp4c9223 = 0; if (count($sp9a47a1) > 0) { list($sp3b6396, $sp3a0fda) = $this->sp039784($sp9a47a1, $sp3a0fda, $sp3b6396, $sp4c9223, null); } $this->deleteOldChilds($sp3b6396, $sp3a0fda); } private function sp039784($sp9a47a1, $sp3a0fda, $sp3b6396, $sp4c9223, $sp5752a5) { $sp3acc9e = $this->container->get('doctrine')->getManager(); foreach ($sp9a47a1 as $sp5b6186 => $spd29c0a) { if (array_key_exists('id', $spd29c0a)) { $sp836266 = $sp3acc9e->getRepository('TellawLeadsFactoryBundle:ReferenceListElement')->find($spd29c0a['id']); $sp836266->setName($spd29c0a['name']); $sp836266->setValue($spd29c0a['value']); $sp3acc9e->flush(); $sp3b6396[$sp3a0fda[$sp4c9223]][$spd29c0a['id']] = true; } else { $sp836266 = new ReferenceListElement(); $sp836266->setName($spd29c0a['name']); $sp836266->setValue($spd29c0a['value']); $sp750e52 = $sp3acc9e->getRepository('TellawLeadsFactoryBundle:ReferenceList')->find($sp3a0fda[$sp4c9223]); $sp836266->setReferenceList($sp750e52); if ($sp5752a5 != null) { $sp5a2975 = $sp3acc9e->getRepository('TellawLeadsFactoryBundle:ReferenceListElement')->find($sp5752a5); $sp836266->setParent($sp5a2975); } $sp3acc9e->persist($sp836266); $sp3acc9e->flush(); $sp3b6396[$sp3a0fda[$sp4c9223]][$sp836266->getId()] = true; } $sp50da49 = $sp836266->getId(); if (array_key_exists('childrens', $spd29c0a)) { if (count($spd29c0a['childrens']) > 0) { list($sp3b6396, $sp3a0fda) = $this->sp039784($spd29c0a['childrens'], $sp3a0fda, $sp3b6396, $sp4c9223 + 1, $sp50da49); } } } return array($sp3b6396, $sp3a0fda); } public function deleteOldChilds($sp3b6396, $sp3a0fda) { array_reverse($sp3a0fda); $sp3acc9e = $this->container->get('doctrine')->getManager(); foreach ($sp3a0fda as $sp6cf2a6) { $spaeb2bc = 'SELECT id FROM `ReferenceListElement` WHERE referencelist_id = :listId'; $sp297eeb = $sp3acc9e->getConnection()->prepare($spaeb2bc); $sp297eeb->bindValue('listId', $sp6cf2a6); $sp297eeb->execute(); $sp4cbf19 = $sp297eeb->fetchAll(); foreach ($sp4cbf19 as $sp773aaa) { if (!array_key_exists($sp773aaa['id'], $sp3b6396[$sp6cf2a6])) { $spa538b7 = $this->container->get('doctrine')->getRepository('TellawLeadsFactoryBundle:ReferenceListElement')->find($sp773aaa['id']); $sp3acc9e = $this->container->get('doctrine')->getManager(); $sp3acc9e->remove($spa538b7); $sp3acc9e->flush(); echo 'Delete : ' . $sp773aaa['id'] . ' - '; } } } } public function getListOfLists($sp6593f3, $sp3a0fda = array()) { if (!in_array($sp6593f3, $sp3a0fda)) { $sp3a0fda[] = $sp6593f3; } $sp6593f3 = $this->getLinkedLists($sp6593f3); if ($sp6593f3) { $sp3a0fda[] = $sp6593f3; $sp3a0fda = $this->getListOfLists($sp6593f3, $sp3a0fda); } return $sp3a0fda; } public function getLinkedLists($sp6593f3) { $sp3acc9e = $this->container->get('doctrine')->getManager(); $spaeb2bc = 'SELECT referencelist_id FROM `ReferenceListElement` WHERE parent_id IN (SELECT id FROM `ReferenceListElement` WHERE referencelist_id = :listId ) GROUP BY referencelist_id'; $sp297eeb = $sp3acc9e->getConnection()->prepare($spaeb2bc); $sp297eeb->bindValue('listId', $sp6593f3); $sp297eeb->execute(); $sp4cbf19 = $sp297eeb->fetchAll(); if (count($sp4cbf19) > 0) { $spe245e4 = $sp4cbf19[0]['referencelist_id']; return $spe245e4; } else { return false; } } public function getUserPreferences() { $sp3840f1 = $this->container->get('session'); if ($sp3840f1->has('user-preferences')) { return $sp3840f1->get('user-preferences'); } else { $sp83b17e = new UserPreferences(); $sp3840f1->set('user-preferences', $sp83b17e); $sp3840f1->save(); return $sp83b17e; } } public function setUserPreferences($sp83b17e) { $sp3840f1 = $this->container->get('session'); $sp3840f1->set('user-preferences', $sp83b17e); $sp3840f1->save(); } }