<?php
namespace Tellaw\LeadsFactoryBundle\Shared; use Tellaw\LeadsFactoryBundle\Entity\UserPreferences; use Tellaw\LeadsFactoryBundle\Entity\Form as FormEntity; class LFUtilsShared { public function updateListElements($sp49a441) { $sp1bfe6a = json_decode($sp49a441, true); $spb06660 = array(); $sp04de88 = $sp1bfe6a['lists']; $sp3e9bac = $sp1bfe6a['elements']; $sp1737e9 = 0; if (count($sp3e9bac) > 0) { list($spb06660, $sp04de88) = $this->sp0d4dca($sp3e9bac, $sp04de88, $spb06660, $sp1737e9, null); } $this->deleteOldChilds($spb06660, $sp04de88); } private function sp0d4dca($sp3e9bac, $sp04de88, $spb06660, $sp1737e9, $spf59f58) { $sp5c2248 = $this->container->get('doctrine')->getManager(); foreach ($sp3e9bac as $spd561ac => $sp8269dc) { if (array_key_exists('id', $sp8269dc)) { $sp9111a1 = $sp5c2248->getRepository('TellawLeadsFactoryBundle:ReferenceListElement')->find($sp8269dc['id']); $sp9111a1->setName($sp8269dc['name']); $sp9111a1->setValue($sp8269dc['value']); $sp5c2248->flush(); $spb06660[$sp04de88[$sp1737e9]][$sp8269dc['id']] = true; } else { $sp9111a1 = new ReferenceListElement(); $sp9111a1->setName($sp8269dc['name']); $sp9111a1->setValue($sp8269dc['value']); $sp7f39d3 = $sp5c2248->getRepository('TellawLeadsFactoryBundle:ReferenceList')->find($sp04de88[$sp1737e9]); $sp9111a1->setReferenceList($sp7f39d3); if ($spf59f58 != null) { $sp0d85c5 = $sp5c2248->getRepository('TellawLeadsFactoryBundle:ReferenceListElement')->find($spf59f58); $sp9111a1->setParent($sp0d85c5); } $sp5c2248->persist($sp9111a1); $sp5c2248->flush(); $spb06660[$sp04de88[$sp1737e9]][$sp9111a1->getId()] = true; } $spc13d95 = $sp9111a1->getId(); if (array_key_exists('childrens', $sp8269dc)) { if (count($sp8269dc['childrens']) > 0) { list($spb06660, $sp04de88) = $this->sp0d4dca($sp8269dc['childrens'], $sp04de88, $spb06660, $sp1737e9 + 1, $spc13d95); } } } return array($spb06660, $sp04de88); } public function deleteOldChilds($spb06660, $sp04de88) { array_reverse($sp04de88); $sp5c2248 = $this->container->get('doctrine')->getManager(); foreach ($sp04de88 as $sp7f3605) { $sp594772 = 'SELECT id FROM `ReferenceListElement` WHERE referencelist_id = :listId'; $spcfe3cf = $sp5c2248->getConnection()->prepare($sp594772); $spcfe3cf->bindValue('listId', $sp7f3605); $spcfe3cf->execute(); $sp24abba = $spcfe3cf->fetchAll(); foreach ($sp24abba as $sp007bb3) { if (!array_key_exists($sp007bb3['id'], $spb06660[$sp7f3605])) { $sp466ee9 = $this->container->get('doctrine')->getRepository('TellawLeadsFactoryBundle:ReferenceListElement')->find($sp007bb3['id']); $sp5c2248 = $this->container->get('doctrine')->getManager(); $sp5c2248->remove($sp466ee9); $sp5c2248->flush(); echo 'Delete : ' . $sp007bb3['id'] . ' - '; } } } } public function getListOfLists($sp306165, $sp04de88 = array()) { if (!in_array($sp306165, $sp04de88)) { $sp04de88[] = $sp306165; } $sp306165 = $this->getLinkedLists($sp306165); if ($sp306165) { $sp04de88[] = $sp306165; $sp04de88 = $this->getListOfLists($sp306165, $sp04de88); } return $sp04de88; } public function getLinkedLists($sp306165) { $sp5c2248 = $this->container->get('doctrine')->getManager(); $sp594772 = 'SELECT referencelist_id FROM `ReferenceListElement` WHERE parent_id IN (SELECT id FROM `ReferenceListElement` WHERE referencelist_id = :listId ) GROUP BY referencelist_id'; $spcfe3cf = $sp5c2248->getConnection()->prepare($sp594772); $spcfe3cf->bindValue('listId', $sp306165); $spcfe3cf->execute(); $sp24abba = $spcfe3cf->fetchAll(); if (count($sp24abba) > 0) { $sp259a15 = $sp24abba[0]['referencelist_id']; return $sp259a15; } else { return false; } } public function getUserPreferences() { $sp37410a = $this->container->get('session'); if ($sp37410a->has('user-preferences')) { return $sp37410a->get('user-preferences'); } else { $sp07129e = new UserPreferences(); $sp37410a->set('user-preferences', $sp07129e); $sp37410a->save(); return $sp07129e; } } public function setUserPreferences($sp07129e) { $sp37410a = $this->container->get('session'); $sp37410a->set('user-preferences', $sp07129e); $sp37410a->save(); } }