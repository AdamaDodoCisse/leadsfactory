<?php
namespace Tellaw\LeadsFactoryBundle\Shared; use Tellaw\LeadsFactoryBundle\Entity\UserPreferences; class LFUtilsShared { public function updateListElements($spde625e) { $sp7f7291 = json_decode($spde625e, true); $sp760b1b = array(); $sp3e8c3f = $sp7f7291['lists']; $sp6ddd79 = $sp7f7291['elements']; $sp16655b = 0; if (count($sp6ddd79) > 0) { list($sp760b1b, $sp3e8c3f) = $this->spe98f7a($sp6ddd79, $sp3e8c3f, $sp760b1b, $sp16655b, null); } $this->deleteOldChilds($sp760b1b, $sp3e8c3f); } private function spe98f7a($sp6ddd79, $sp3e8c3f, $sp760b1b, $sp16655b, $sp848d55) { $sp6da34d = $this->container->get('doctrine')->getManager(); foreach ($sp6ddd79 as $sp99c47e => $sp8da61b) { if (array_key_exists('id', $sp8da61b)) { $sp201464 = $sp6da34d->getRepository('TellawLeadsFactoryBundle:ReferenceListElement')->find($sp8da61b['id']); $sp201464->setName($sp8da61b['name']); $sp201464->setValue($sp8da61b['value']); $sp6da34d->flush(); $sp760b1b[$sp3e8c3f[$sp16655b]][$sp8da61b['id']] = true; } else { $sp201464 = new ReferenceListElement(); $sp201464->setName($sp8da61b['name']); $sp201464->setValue($sp8da61b['value']); $sp0ee3da = $sp6da34d->getRepository('TellawLeadsFactoryBundle:ReferenceList')->find($sp3e8c3f[$sp16655b]); $sp201464->setReferenceList($sp0ee3da); if ($sp848d55 != null) { $spb0dcc5 = $sp6da34d->getRepository('TellawLeadsFactoryBundle:ReferenceListElement')->find($sp848d55); $sp201464->setParent($spb0dcc5); } $sp6da34d->persist($sp201464); $sp6da34d->flush(); $sp760b1b[$sp3e8c3f[$sp16655b]][$sp201464->getId()] = true; } $spfc0012 = $sp201464->getId(); if (array_key_exists('childrens', $sp8da61b)) { if (count($sp8da61b['childrens']) > 0) { list($sp760b1b, $sp3e8c3f) = $this->spe98f7a($sp8da61b['childrens'], $sp3e8c3f, $sp760b1b, $sp16655b + 1, $spfc0012); } } } return array($sp760b1b, $sp3e8c3f); } public function deleteOldChilds($sp760b1b, $sp3e8c3f) { array_reverse($sp3e8c3f); $sp6da34d = $this->container->get('doctrine')->getManager(); foreach ($sp3e8c3f as $sp403a1d) { $spab23b9 = 'SELECT id FROM `ReferenceListElement` WHERE referencelist_id = :listId'; $sp7019f1 = $sp6da34d->getConnection()->prepare($spab23b9); $sp7019f1->bindValue('listId', $sp403a1d); $sp7019f1->execute(); $sp9c63fc = $sp7019f1->fetchAll(); foreach ($sp9c63fc as $spb15b59) { if (!array_key_exists($spb15b59['id'], $sp760b1b[$sp403a1d])) { $sp4e0be1 = $this->container->get('doctrine')->getRepository('TellawLeadsFactoryBundle:ReferenceListElement')->find($spb15b59['id']); $sp6da34d = $this->container->get('doctrine')->getManager(); $sp6da34d->remove($sp4e0be1); $sp6da34d->flush(); echo 'Delete : ' . $spb15b59['id'] . ' - '; } } } } public function getListOfLists($spebae6f, $sp3e8c3f = array()) { if (!in_array($spebae6f, $sp3e8c3f)) { $sp3e8c3f[] = $spebae6f; } $spebae6f = $this->getLinkedLists($spebae6f); if ($spebae6f) { $sp3e8c3f[] = $spebae6f; $sp3e8c3f = $this->getListOfLists($spebae6f, $sp3e8c3f); } return $sp3e8c3f; } public function getLinkedLists($spebae6f) { $sp6da34d = $this->container->get('doctrine')->getManager(); $spab23b9 = 'SELECT referencelist_id FROM `ReferenceListElement` WHERE parent_id IN (SELECT id FROM `ReferenceListElement` WHERE referencelist_id = :listId ) GROUP BY referencelist_id'; $sp7019f1 = $sp6da34d->getConnection()->prepare($spab23b9); $sp7019f1->bindValue('listId', $spebae6f); $sp7019f1->execute(); $sp9c63fc = $sp7019f1->fetchAll(); if (count($sp9c63fc) > 0) { $sp290114 = $sp9c63fc[0]['referencelist_id']; return $sp290114; } else { return false; } } public function getUserPreferences() { $sp61e3a0 = $this->container->get('session'); if ($sp61e3a0->has('user-preferences')) { return $sp61e3a0->get('user-preferences'); } else { $sp696f77 = new UserPreferences(); $sp61e3a0->set('user-preferences', $sp696f77); $sp61e3a0->save(); return $sp696f77; } } public function setUserPreferences($sp696f77) { $sp61e3a0 = $this->container->get('session'); $sp61e3a0->set('user-preferences', $sp696f77); $sp61e3a0->save(); } }