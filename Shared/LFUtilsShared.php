<?php
namespace Tellaw\LeadsFactoryBundle\Shared; use Tellaw\LeadsFactoryBundle\Entity\UserPreferences; class LFUtilsShared { public function updateListElements($sp4fd499) { $sp64d1f1 = json_decode($sp4fd499, true); $spf24f8c = array(); $sp465fda = $sp64d1f1['lists']; $spbf6654 = $sp64d1f1['elements']; $spb094c4 = 0; if (count($spbf6654) > 0) { list($spf24f8c, $sp465fda) = $this->spea2659($spbf6654, $sp465fda, $spf24f8c, $spb094c4, null); } $this->deleteOldChilds($spf24f8c, $sp465fda); } private function spea2659($spbf6654, $sp465fda, $spf24f8c, $spb094c4, $spf33430) { $spc9900d = $this->container->get('doctrine')->getManager(); foreach ($spbf6654 as $sp89c202 => $sp8bdbbb) { if (array_key_exists('id', $sp8bdbbb)) { $sp90ea86 = $spc9900d->getRepository('TellawLeadsFactoryBundle:ReferenceListElement')->find($sp8bdbbb['id']); $sp90ea86->setName($sp8bdbbb['name']); $sp90ea86->setValue($sp8bdbbb['value']); $spc9900d->flush(); $spf24f8c[$sp465fda[$spb094c4]][$sp8bdbbb['id']] = true; } else { $sp90ea86 = new ReferenceListElement(); $sp90ea86->setName($sp8bdbbb['name']); $sp90ea86->setValue($sp8bdbbb['value']); $sp0f356b = $spc9900d->getRepository('TellawLeadsFactoryBundle:ReferenceList')->find($sp465fda[$spb094c4]); $sp90ea86->setReferenceList($sp0f356b); if ($spf33430 != null) { $sp6a143e = $spc9900d->getRepository('TellawLeadsFactoryBundle:ReferenceListElement')->find($spf33430); $sp90ea86->setParent($sp6a143e); } $spc9900d->persist($sp90ea86); $spc9900d->flush(); $spf24f8c[$sp465fda[$spb094c4]][$sp90ea86->getId()] = true; } $sp8cb57c = $sp90ea86->getId(); if (array_key_exists('childrens', $sp8bdbbb)) { if (count($sp8bdbbb['childrens']) > 0) { list($spf24f8c, $sp465fda) = $this->spea2659($sp8bdbbb['childrens'], $sp465fda, $spf24f8c, $spb094c4 + 1, $sp8cb57c); } } } return array($spf24f8c, $sp465fda); } public function deleteOldChilds($spf24f8c, $sp465fda) { array_reverse($sp465fda); $spc9900d = $this->container->get('doctrine')->getManager(); foreach ($sp465fda as $spf17174) { $spd4aba7 = 'SELECT id FROM `ReferenceListElement` WHERE referencelist_id = :listId'; $sp49f6e6 = $spc9900d->getConnection()->prepare($spd4aba7); $sp49f6e6->bindValue('listId', $spf17174); $sp49f6e6->execute(); $sp5f127a = $sp49f6e6->fetchAll(); foreach ($sp5f127a as $spff3006) { if (!array_key_exists($spff3006['id'], $spf24f8c[$spf17174])) { $sp60f213 = $this->container->get('doctrine')->getRepository('TellawLeadsFactoryBundle:ReferenceListElement')->find($spff3006['id']); $spc9900d = $this->container->get('doctrine')->getManager(); $spc9900d->remove($sp60f213); $spc9900d->flush(); echo 'Delete : ' . $spff3006['id'] . ' - '; } } } } public function getListOfLists($sp9ce646, $sp465fda = array()) { if (!in_array($sp9ce646, $sp465fda)) { $sp465fda[] = $sp9ce646; } $sp9ce646 = $this->getLinkedLists($sp9ce646); if ($sp9ce646) { $sp465fda[] = $sp9ce646; $sp465fda = $this->getListOfLists($sp9ce646, $sp465fda); } return $sp465fda; } public function getLinkedLists($sp9ce646) { $spc9900d = $this->container->get('doctrine')->getManager(); $spd4aba7 = 'SELECT referencelist_id FROM `ReferenceListElement` WHERE parent_id IN (SELECT id FROM `ReferenceListElement` WHERE referencelist_id = :listId ) GROUP BY referencelist_id'; $sp49f6e6 = $spc9900d->getConnection()->prepare($spd4aba7); $sp49f6e6->bindValue('listId', $sp9ce646); $sp49f6e6->execute(); $sp5f127a = $sp49f6e6->fetchAll(); if (count($sp5f127a) > 0) { $sp29b182 = $sp5f127a[0]['referencelist_id']; return $sp29b182; } else { return false; } } public function getUserPreferences() { $sp45c471 = $this->container->get('session'); if ($sp45c471->has('user-preferences')) { return $sp45c471->get('user-preferences'); } else { $spbd4950 = new UserPreferences(); $sp45c471->set('user-preferences', $spbd4950); $sp45c471->save(); return $spbd4950; } } public function setUserPreferences($spbd4950) { $sp45c471 = $this->container->get('session'); $sp45c471->set('user-preferences', $spbd4950); $sp45c471->save(); } }