<?php
namespace Tellaw\LeadsFactoryBundle\Shared; use Tellaw\LeadsFactoryBundle\Utils\AlertUtils; class AlertUtilsShared { public function checkWarningStatus($sp1d98f0, $sp20c771, $sp84e3f3) { $spf524a2 = $this->getWarningRules($sp84e3f3['rules']); $sp4fa652 = $this->getAlertRules($sp84e3f3['rules']); if (count($sp4fa652) > 0) { if ($sp4fa652['min'] != null && $sp1d98f0 <= $sp4fa652['min']) { return AlertUtils::$_STATUS_ERROR; } if ($sp4fa652['max'] != null && $sp1d98f0 >= $sp4fa652['max']) { return AlertUtils::$_STATUS_ERROR; } if ($sp4fa652['delta'] != null && $this->getDeltaPourcentValue($sp20c771, $sp1d98f0, $sp4fa652['delta'])) { return AlertUtils::$_STATUS_ERROR; } } else { return AlertUtils::$_STATUS_UNKNOWN; } if (count($spf524a2) > 0) { if ($spf524a2['min'] != null && $sp1d98f0 <= $spf524a2['min']) { return AlertUtils::$_STATUS_WARNING; } if ($spf524a2['max'] != null && $sp1d98f0 >= $spf524a2['max']) { return AlertUtils::$_STATUS_WARNING; } if ($spf524a2['delta'] != null && $this->getDeltaPourcentValue($sp20c771, $sp1d98f0, $spf524a2['delta'])) { return AlertUtils::$_STATUS_WARNING; } } else { return AlertUtils::$_STATUS_UNKNOWN; } return AlertUtils::$_STATUS_OK; } public function getWarningRules($sp84e3f3) { $spf524a2 = isset($sp84e3f3['warning']) ? $sp84e3f3['warning'] : false; if (is_array($spf524a2)) { if (!array_key_exists('min', $spf524a2)) { $spf524a2['min'] = null; } if (!array_key_exists('max', $spf524a2)) { $spf524a2['min'] = null; } if (!array_key_exists('delta', $spf524a2)) { $spf524a2['min'] = null; } return $spf524a2; } return array(); } public function getAlertRules($sp84e3f3) { $sp4fa652 = isset($sp84e3f3['error']) ? $sp84e3f3['error'] : false; if (is_array($sp4fa652)) { if (!array_key_exists('min', $sp4fa652)) { $sp4fa652['min'] = null; } if (!array_key_exists('max', $sp4fa652)) { $sp4fa652['max'] = null; } if (!array_key_exists('delta', $sp4fa652)) { $sp4fa652['delta'] = null; } return $sp4fa652; } return array(); } public function getDeltaPourcentValue($spfbc223, $sp4a2de7, $spbb435a) { if ($spbb435a == 0) { return '&laquo;NAN&raquo;'; } $spca2918 = $spfbc223 * $spbb435a / 100; if ($spfbc223 - $spca2918 > $sp4a2de7) { return true; } if ($spfbc223 + $spca2918 < $sp4a2de7) { return true; } return false; } public function getDeltaPourcent($spfbc223, $sp4a2de7) { if ($spfbc223 == 0) { return '&laquo; Données indisponibles &raquo;'; } if ($sp4a2de7 == 0) { return '&laquo; calcul impossible &raquo;'; } $spff3006 = $sp4a2de7 * 100 / $spfbc223; return $spff3006; } public function setValuesForAlerts($sp90ea86) { $spbca52b = $this->entity_manager->getRepository('TellawLeadsFactoryBundle:Form'); if ($sp90ea86->getType() == 'formType') { $sp246ecc = $spbca52b->findByFormType($sp90ea86->getId()); } else { $sp450a62 = $spbca52b->find($sp90ea86->getId()); $sp246ecc = array($sp450a62); } $spdfd14e = new \DateTime(); $sp90ea86->todayValue = $this->getLeadsCountForForms($sp246ecc, $spdfd14e); $spdfd14e = new \DateTime(); $spdfd14e = $spdfd14e->sub(new \DateInterval('P01D')); $sp90ea86->yesterdayValue = $this->getLeadsCountForForms($sp246ecc, $spdfd14e); $sp90ea86->textualYesterdayDay = $this->day[$spdfd14e->format('N')] . ' ' . $spdfd14e->format('d') . ' ' . $this->month[$spdfd14e->format('n')]; $spdfd14e = new \DateTime(); $spdfd14e = $spdfd14e->sub(new \DateInterval('P08D')); $sp90ea86->weekBeforeValue = $this->getLeadsCountForForms($sp246ecc, $spdfd14e); $sp90ea86->textualWeekBeforeDay = $this->day[$spdfd14e->format('N')] . ' ' . $spdfd14e->format('d') . ' ' . $this->month[$spdfd14e->format('n')]; $sp90ea86->yesterdayVariation = $this->getDeltaPourcent($sp90ea86->weekBeforeValue, $sp90ea86->yesterdayValue); $sp84e3f3 = $sp90ea86->getRules(); if (empty($sp84e3f3)) { $sp9f02aa = AlertUtils::$_STATUS_UNKNOWN; } else { $sp9f02aa = $this->checkWarningStatus($sp90ea86->yesterdayValue, $sp90ea86->weekBeforeValue, $sp90ea86->getRules($sp84e3f3)); } $sp90ea86->yesterdayStatus = $sp9f02aa; if ($sp9f02aa == AlertUtils::$_STATUS_ERROR) { $sp90ea86->yesterdayStatusColor = 'pink'; $sp90ea86->yesterdayStatusText = 'Erreur'; } else { if ($sp9f02aa == AlertUtils::$_STATUS_WARNING) { $sp90ea86->yesterdayStatusColor = 'yellow'; $sp90ea86->yesterdayStatusText = 'Attention!'; } else { if ($sp9f02aa == AlertUtils::$_STATUS_UNKNOWN) { $sp90ea86->yesterdayStatusColor = 'black'; $sp90ea86->yesterdayStatusText = 'Aucune donnée'; } else { $sp90ea86->yesterdayStatusColor = 'green'; $sp90ea86->yesterdayStatusText = 'Status OK'; } } } } }