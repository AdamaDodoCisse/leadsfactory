<?php
namespace Tellaw\LeadsFactoryBundle\Shared; use Tellaw\LeadsFactoryBundle\Utils\AlertUtils; class AlertUtilsShared { public function checkWarningStatus($spe18283, $spccba51, $spf0ee7c) { $sp133a0c = $this->getWarningRules($spf0ee7c['rules']); $sp765656 = $this->getAlertRules($spf0ee7c['rules']); if (count($sp765656) > 0) { if ($sp765656['min'] != null && $spe18283 <= $sp765656['min']) { return AlertUtils::$_STATUS_ERROR; } if ($sp765656['max'] != null && $spe18283 >= $sp765656['max']) { return AlertUtils::$_STATUS_ERROR; } if ($sp765656['delta'] != null && $this->getDeltaPourcentValue($spccba51, $spe18283, $sp765656['delta'])) { return AlertUtils::$_STATUS_ERROR; } } else { return AlertUtils::$_STATUS_UNKNOWN; } if (count($sp133a0c) > 0) { if ($sp133a0c['min'] != null && $spe18283 <= $sp133a0c['min']) { return AlertUtils::$_STATUS_WARNING; } if ($sp133a0c['max'] != null && $spe18283 >= $sp133a0c['max']) { return AlertUtils::$_STATUS_WARNING; } if ($sp133a0c['delta'] != null && $this->getDeltaPourcentValue($spccba51, $spe18283, $sp133a0c['delta'])) { return AlertUtils::$_STATUS_WARNING; } } else { return AlertUtils::$_STATUS_UNKNOWN; } return AlertUtils::$_STATUS_OK; } public function getWarningRules($spf0ee7c) { $sp133a0c = isset($spf0ee7c['warning']) ? $spf0ee7c['warning'] : false; if (is_array($sp133a0c)) { if (!array_key_exists('min', $sp133a0c)) { $sp133a0c['min'] = null; } if (!array_key_exists('max', $sp133a0c)) { $sp133a0c['min'] = null; } if (!array_key_exists('delta', $sp133a0c)) { $sp133a0c['min'] = null; } return $sp133a0c; } return array(); } public function getAlertRules($spf0ee7c) { $sp765656 = isset($spf0ee7c['error']) ? $spf0ee7c['error'] : false; if (is_array($sp765656)) { if (!array_key_exists('min', $sp765656)) { $sp765656['min'] = null; } if (!array_key_exists('max', $sp765656)) { $sp765656['max'] = null; } if (!array_key_exists('delta', $sp765656)) { $sp765656['delta'] = null; } return $sp765656; } return array(); } public function getDeltaPourcentValue($sp867aae, $spaee5de, $sp666873) { if ($sp666873 == 0) { return '&laquo;NAN&raquo;'; } $sp1763c9 = $sp867aae * $sp666873 / 100; if ($sp867aae - $sp1763c9 > $spaee5de) { return true; } if ($sp867aae + $sp1763c9 < $spaee5de) { return true; } return false; } public function getDeltaPourcent($sp867aae, $spaee5de) { if ($sp867aae == 0) { return '&laquo; Données indisponibles &raquo;'; } if ($spaee5de == 0) { return '&laquo; calcul impossible &raquo;'; } $sp007bb3 = $spaee5de * 100 / $sp867aae; return $sp007bb3; } public function setValuesForAlerts($sp9111a1) { $sp4ec868 = $this->entity_manager->getRepository('TellawLeadsFactoryBundle:Form'); if ($sp9111a1->getType() == 'formType') { $spb28b81 = $sp4ec868->findByFormType($sp9111a1->getId()); } else { $sp368158 = $sp4ec868->find($sp9111a1->getId()); $spb28b81 = array($sp368158); } $sp6a2d20 = new \DateTime(); $sp9111a1->todayValue = $this->getLeadsCountForForms($spb28b81, $sp6a2d20); $sp6a2d20 = new \DateTime(); $sp6a2d20 = $sp6a2d20->sub(new \DateInterval('P01D')); $sp9111a1->yesterdayValue = $this->getLeadsCountForForms($spb28b81, $sp6a2d20); $sp9111a1->textualYesterdayDay = $this->day[$sp6a2d20->format('N')] . ' ' . $sp6a2d20->format('d') . ' ' . $this->month[$sp6a2d20->format('n')]; $sp6a2d20 = new \DateTime(); $sp6a2d20 = $sp6a2d20->sub(new \DateInterval('P08D')); $sp9111a1->weekBeforeValue = $this->getLeadsCountForForms($spb28b81, $sp6a2d20); $sp9111a1->textualWeekBeforeDay = $this->day[$sp6a2d20->format('N')] . ' ' . $sp6a2d20->format('d') . ' ' . $this->month[$sp6a2d20->format('n')]; $sp9111a1->yesterdayVariation = $this->getDeltaPourcent($sp9111a1->weekBeforeValue, $sp9111a1->yesterdayValue); $spf0ee7c = $sp9111a1->getRules(); if (empty($spf0ee7c)) { $sp47fc23 = AlertUtils::$_STATUS_UNKNOWN; } else { $sp47fc23 = $this->checkWarningStatus($sp9111a1->yesterdayValue, $sp9111a1->weekBeforeValue, $sp9111a1->getRules($spf0ee7c)); } $sp9111a1->yesterdayStatus = $sp47fc23; if ($sp47fc23 == AlertUtils::$_STATUS_ERROR) { $sp9111a1->yesterdayStatusColor = 'pink'; $sp9111a1->yesterdayStatusText = 'Erreur'; } else { if ($sp47fc23 == AlertUtils::$_STATUS_WARNING) { $sp9111a1->yesterdayStatusColor = 'yellow'; $sp9111a1->yesterdayStatusText = 'Attention!'; } else { if ($sp47fc23 == AlertUtils::$_STATUS_UNKNOWN) { $sp9111a1->yesterdayStatusColor = 'black'; $sp9111a1->yesterdayStatusText = 'Aucune donnée'; } else { $sp9111a1->yesterdayStatusColor = 'green'; $sp9111a1->yesterdayStatusText = 'Status OK'; } } } } }