<?php
namespace Tellaw\LeadsFactoryBundle\Shared; use Tellaw\LeadsFactoryBundle\Utils\AlertUtils; class AlertUtilsShared { public function checkWarningStatus($sp416977, $sp8980e5, $spe331ad) { $sp88e7de = $this->getWarningRules($spe331ad['rules']); $spbe733d = $this->getAlertRules($spe331ad['rules']); if (count($spbe733d) > 0) { if ($spbe733d['min'] != null && $sp416977 <= $spbe733d['min']) { return AlertUtils::$_STATUS_ERROR; } if ($spbe733d['max'] != null && $sp416977 >= $spbe733d['max']) { return AlertUtils::$_STATUS_ERROR; } if ($spbe733d['delta'] != null && $this->getDeltaPourcentValue($sp8980e5, $sp416977, $spbe733d['delta'])) { return AlertUtils::$_STATUS_ERROR; } } else { return AlertUtils::$_STATUS_UNKNOWN; } if (count($sp88e7de) > 0) { if ($sp88e7de['min'] != null && $sp416977 <= $sp88e7de['min']) { return AlertUtils::$_STATUS_WARNING; } if ($sp88e7de['max'] != null && $sp416977 >= $sp88e7de['max']) { return AlertUtils::$_STATUS_WARNING; } if ($sp88e7de['delta'] != null && $this->getDeltaPourcentValue($sp8980e5, $sp416977, $sp88e7de['delta'])) { return AlertUtils::$_STATUS_WARNING; } } else { return AlertUtils::$_STATUS_UNKNOWN; } return AlertUtils::$_STATUS_OK; } public function getWarningRules($spe331ad) { $sp88e7de = isset($spe331ad['warning']) ? $spe331ad['warning'] : false; if (is_array($sp88e7de)) { if (!array_key_exists('min', $sp88e7de)) { $sp88e7de['min'] = null; } if (!array_key_exists('max', $sp88e7de)) { $sp88e7de['min'] = null; } if (!array_key_exists('delta', $sp88e7de)) { $sp88e7de['min'] = null; } return $sp88e7de; } return array(); } public function getAlertRules($spe331ad) { $spbe733d = isset($spe331ad['error']) ? $spe331ad['error'] : false; if (is_array($spbe733d)) { if (!array_key_exists('min', $spbe733d)) { $spbe733d['min'] = null; } if (!array_key_exists('max', $spbe733d)) { $spbe733d['max'] = null; } if (!array_key_exists('delta', $spbe733d)) { $spbe733d['delta'] = null; } return $spbe733d; } return array(); } public function getDeltaPourcentValue($spe93625, $spbf57b5, $sp6e5203) { if ($sp6e5203 == 0) { return '&laquo;NAN&raquo;'; } $sp29bce7 = $spe93625 * $sp6e5203 / 100; if ($spe93625 - $sp29bce7 > $spbf57b5) { return true; } if ($spe93625 + $sp29bce7 < $spbf57b5) { return true; } return false; } public function getDeltaPourcent($spe93625, $spbf57b5) { if ($spe93625 == 0) { return '&laquo; Données indisponibles &raquo;'; } if ($spbf57b5 == 0) { return '&laquo; calcul impossible &raquo;'; } $spb15b59 = $spbf57b5 * 100 / $spe93625; return $spb15b59; } public function setValuesForAlerts($sp201464) { $sp2dc188 = $this->entity_manager->getRepository('TellawLeadsFactoryBundle:Form'); if ($sp201464->getType() == 'formType') { $spf10725 = $sp2dc188->findByFormType($sp201464->getId()); } else { $sp58caff = $sp2dc188->find($sp201464->getId()); $spf10725 = array($sp58caff); } $sp94ac6d = new \DateTime(); $sp201464->todayValue = $this->getLeadsCountForForms($spf10725, $sp94ac6d); $sp94ac6d = new \DateTime(); $sp94ac6d = $sp94ac6d->sub(new \DateInterval('P01D')); $sp201464->yesterdayValue = $this->getLeadsCountForForms($spf10725, $sp94ac6d); $sp201464->textualYesterdayDay = $this->day[$sp94ac6d->format('N')] . ' ' . $sp94ac6d->format('d') . ' ' . $this->month[$sp94ac6d->format('n')]; $sp94ac6d = new \DateTime(); $sp94ac6d = $sp94ac6d->sub(new \DateInterval('P08D')); $sp201464->weekBeforeValue = $this->getLeadsCountForForms($spf10725, $sp94ac6d); $sp201464->textualWeekBeforeDay = $this->day[$sp94ac6d->format('N')] . ' ' . $sp94ac6d->format('d') . ' ' . $this->month[$sp94ac6d->format('n')]; $sp201464->yesterdayVariation = $this->getDeltaPourcent($sp201464->weekBeforeValue, $sp201464->yesterdayValue); $spe331ad = $sp201464->getRules(); if (empty($spe331ad)) { $sp7efab1 = AlertUtils::$_STATUS_UNKNOWN; } else { $sp7efab1 = $this->checkWarningStatus($sp201464->yesterdayValue, $sp201464->weekBeforeValue, $sp201464->getRules($spe331ad)); } $sp201464->yesterdayStatus = $sp7efab1; if ($sp7efab1 == AlertUtils::$_STATUS_ERROR) { $sp201464->yesterdayStatusColor = 'pink'; $sp201464->yesterdayStatusText = 'Erreur'; } else { if ($sp7efab1 == AlertUtils::$_STATUS_WARNING) { $sp201464->yesterdayStatusColor = 'yellow'; $sp201464->yesterdayStatusText = 'Attention!'; } else { if ($sp7efab1 == AlertUtils::$_STATUS_UNKNOWN) { $sp201464->yesterdayStatusColor = 'black'; $sp201464->yesterdayStatusText = 'Aucune donnée'; } else { $sp201464->yesterdayStatusColor = 'green'; $sp201464->yesterdayStatusText = 'Status OK'; } } } } }