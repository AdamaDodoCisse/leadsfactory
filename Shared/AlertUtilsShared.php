<?php
namespace Tellaw\LeadsFactoryBundle\Shared; use Tellaw\LeadsFactoryBundle\Utils\AlertUtils; class AlertUtilsShared { public function checkWarningStatus($sp05d550, $sp42ff27, $spda32d0) { $spbbebb1 = $this->getWarningRules($spda32d0['rules']); $spab4a9c = $this->getAlertRules($spda32d0['rules']); if (count($spab4a9c) > 0) { if ($spab4a9c['min'] != null && $sp05d550 <= $spab4a9c['min']) { return AlertUtils::$_STATUS_ERROR; } if ($spab4a9c['max'] != null && $sp05d550 >= $spab4a9c['max']) { return AlertUtils::$_STATUS_ERROR; } if ($spab4a9c['delta'] != null && $this->getDeltaPourcentValue($sp42ff27, $sp05d550, $spab4a9c['delta'])) { return AlertUtils::$_STATUS_ERROR; } } else { return AlertUtils::$_STATUS_UNKNOWN; } if (count($spbbebb1) > 0) { if ($spbbebb1['min'] != null && $sp05d550 <= $spbbebb1['min']) { return AlertUtils::$_STATUS_WARNING; } if ($spbbebb1['max'] != null && $sp05d550 >= $spbbebb1['max']) { return AlertUtils::$_STATUS_WARNING; } if ($spbbebb1['delta'] != null && $this->getDeltaPourcentValue($sp42ff27, $sp05d550, $spbbebb1['delta'])) { return AlertUtils::$_STATUS_WARNING; } } else { return AlertUtils::$_STATUS_UNKNOWN; } return AlertUtils::$_STATUS_OK; } public function getWarningRules($spda32d0) { $spbbebb1 = isset($spda32d0['warning']) ? $spda32d0['warning'] : false; if (is_array($spbbebb1)) { if (!array_key_exists('min', $spbbebb1)) { $spbbebb1['min'] = null; } if (!array_key_exists('max', $spbbebb1)) { $spbbebb1['min'] = null; } if (!array_key_exists('delta', $spbbebb1)) { $spbbebb1['min'] = null; } return $spbbebb1; } return array(); } public function getAlertRules($spda32d0) { $spab4a9c = isset($spda32d0['error']) ? $spda32d0['error'] : false; if (is_array($spab4a9c)) { if (!array_key_exists('min', $spab4a9c)) { $spab4a9c['min'] = null; } if (!array_key_exists('max', $spab4a9c)) { $spab4a9c['max'] = null; } if (!array_key_exists('delta', $spab4a9c)) { $spab4a9c['delta'] = null; } return $spab4a9c; } return array(); } public function getDeltaPourcentValue($spf8ddc9, $sp2365a2, $sp5a70dd) { if ($sp5a70dd == 0) { return '&laquo;NAN&raquo;'; } $sp907eb4 = $spf8ddc9 * $sp5a70dd / 100; if ($spf8ddc9 - $sp907eb4 > $sp2365a2) { return true; } if ($spf8ddc9 + $sp907eb4 < $sp2365a2) { return true; } return false; } public function getDeltaPourcent($spf8ddc9, $sp2365a2) { if ($spf8ddc9 == 0) { return '&laquo; Données indisponibles &raquo;'; } if ($sp2365a2 == 0) { return '&laquo; calcul impossible &raquo;'; } $sp3c24b2 = $sp2365a2 * 100 / $spf8ddc9; return $sp3c24b2; } public function setValuesForAlerts($sp56f784) { $spdcbc66 = $this->entity_manager->getRepository('TellawLeadsFactoryBundle:Form'); if ($sp56f784->getType() == 'formType') { $spdeaad5 = $spdcbc66->findByFormType($sp56f784->getId()); } else { $spa09441 = $spdcbc66->find($sp56f784->getId()); $spdeaad5 = array($spa09441); } $sp5462e3 = new \DateTime(); $sp56f784->todayValue = $this->getLeadsCountForForms($spdeaad5, $sp5462e3); $sp5462e3 = new \DateTime(); $sp5462e3 = $sp5462e3->sub(new \DateInterval('P01D')); $sp56f784->yesterdayValue = $this->getLeadsCountForForms($spdeaad5, $sp5462e3); $sp56f784->textualYesterdayDay = $this->day[$sp5462e3->format('N')] . ' ' . $sp5462e3->format('d') . ' ' . $this->month[$sp5462e3->format('n')]; $sp5462e3 = new \DateTime(); $sp5462e3 = $sp5462e3->sub(new \DateInterval('P08D')); $sp56f784->weekBeforeValue = $this->getLeadsCountForForms($spdeaad5, $sp5462e3); $sp56f784->textualWeekBeforeDay = $this->day[$sp5462e3->format('N')] . ' ' . $sp5462e3->format('d') . ' ' . $this->month[$sp5462e3->format('n')]; $sp56f784->yesterdayVariation = $this->getDeltaPourcent($sp56f784->weekBeforeValue, $sp56f784->yesterdayValue); $spda32d0 = $sp56f784->getRules(); if (empty($spda32d0)) { $sp8b6fa2 = AlertUtils::$_STATUS_UNKNOWN; } else { $sp8b6fa2 = $this->checkWarningStatus($sp56f784->yesterdayValue, $sp56f784->weekBeforeValue, $sp56f784->getRules($spda32d0)); } $sp56f784->yesterdayStatus = $sp8b6fa2; if ($sp8b6fa2 == AlertUtils::$_STATUS_ERROR) { $sp56f784->yesterdayStatusColor = 'pink'; $sp56f784->yesterdayStatusText = 'Erreur'; } else { if ($sp8b6fa2 == AlertUtils::$_STATUS_WARNING) { $sp56f784->yesterdayStatusColor = 'yellow'; $sp56f784->yesterdayStatusText = 'Attention!'; } else { if ($sp8b6fa2 == AlertUtils::$_STATUS_UNKNOWN) { $sp56f784->yesterdayStatusColor = 'black'; $sp56f784->yesterdayStatusText = 'Aucune donnée'; } else { $sp56f784->yesterdayStatusColor = 'green'; $sp56f784->yesterdayStatusText = 'Status OK'; } } } } }