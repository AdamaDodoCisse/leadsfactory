<?php
namespace Tellaw\LeadsFactoryBundle\Shared; use Tellaw\LeadsFactoryBundle\Utils\AlertUtils; class AlertUtilsShared { public function checkWarningStatus($sp92c3b1, $sp41b3b1, $sp35c1ca) { $sp0cbc5a = $this->getWarningRules($sp35c1ca['rules']); $sp41f0f7 = $this->getAlertRules($sp35c1ca['rules']); if (count($sp41f0f7) > 0) { if ($sp41f0f7['min'] != null && $sp92c3b1 <= $sp41f0f7['min']) { return AlertUtils::$_STATUS_ERROR; } if ($sp41f0f7['max'] != null && $sp92c3b1 >= $sp41f0f7['max']) { return AlertUtils::$_STATUS_ERROR; } if ($sp41f0f7['delta'] != null && $this->getDeltaPourcentValue($sp41b3b1, $sp92c3b1, $sp41f0f7['delta'])) { return AlertUtils::$_STATUS_ERROR; } } else { return AlertUtils::$_STATUS_UNKNOWN; } if (count($sp0cbc5a) > 0) { if ($sp0cbc5a['min'] != null && $sp92c3b1 <= $sp0cbc5a['min']) { return AlertUtils::$_STATUS_WARNING; } if ($sp0cbc5a['max'] != null && $sp92c3b1 >= $sp0cbc5a['max']) { return AlertUtils::$_STATUS_WARNING; } if ($sp0cbc5a['delta'] != null && $this->getDeltaPourcentValue($sp41b3b1, $sp92c3b1, $sp0cbc5a['delta'])) { return AlertUtils::$_STATUS_WARNING; } } else { return AlertUtils::$_STATUS_UNKNOWN; } return AlertUtils::$_STATUS_OK; } public function getWarningRules($sp35c1ca) { $sp0cbc5a = isset($sp35c1ca['warning']) ? $sp35c1ca['warning'] : false; if (is_array($sp0cbc5a)) { if (!array_key_exists('min', $sp0cbc5a)) { $sp0cbc5a['min'] = null; } if (!array_key_exists('max', $sp0cbc5a)) { $sp0cbc5a['min'] = null; } if (!array_key_exists('delta', $sp0cbc5a)) { $sp0cbc5a['min'] = null; } return $sp0cbc5a; } return array(); } public function getAlertRules($sp35c1ca) { $sp41f0f7 = isset($sp35c1ca['error']) ? $sp35c1ca['error'] : false; if (is_array($sp41f0f7)) { if (!array_key_exists('min', $sp41f0f7)) { $sp41f0f7['min'] = null; } if (!array_key_exists('max', $sp41f0f7)) { $sp41f0f7['max'] = null; } if (!array_key_exists('delta', $sp41f0f7)) { $sp41f0f7['delta'] = null; } return $sp41f0f7; } return array(); } public function getDeltaPourcentValue($sp85ab56, $sp38ee8a, $spca41a0) { if ($spca41a0 == 0) { return '&laquo;NAN&raquo;'; } $spd0f2d1 = $sp85ab56 * $spca41a0 / 100; if ($sp85ab56 - $spd0f2d1 > $sp38ee8a) { return true; } if ($sp85ab56 + $spd0f2d1 < $sp38ee8a) { return true; } return false; } public function getDeltaPourcent($sp85ab56, $sp38ee8a) { if ($sp85ab56 == 0) { return '&laquo; Données indisponibles &raquo;'; } if ($sp38ee8a == 0) { return '&laquo; calcul impossible &raquo;'; } $sp773aaa = $sp38ee8a * 100 / $sp85ab56; return $sp773aaa; } public function setValuesForAlerts($sp836266) { $sp5192d1 = $this->entity_manager->getRepository('TellawLeadsFactoryBundle:Form'); if ($sp836266->getType() == 'formType') { $spc931e9 = $sp5192d1->findByFormType($sp836266->getId()); } else { $sp9bb2c9 = $sp5192d1->find($sp836266->getId()); $spc931e9 = array($sp9bb2c9); } $sp7be3cf = new \DateTime(); $sp836266->todayValue = $this->getLeadsCountForForms($spc931e9, $sp7be3cf); $sp7be3cf = new \DateTime(); $sp7be3cf = $sp7be3cf->sub(new \DateInterval('P01D')); $sp836266->yesterdayValue = $this->getLeadsCountForForms($spc931e9, $sp7be3cf); $sp836266->textualYesterdayDay = $this->day[$sp7be3cf->format('N')] . ' ' . $sp7be3cf->format('d') . ' ' . $this->month[$sp7be3cf->format('n')]; $sp7be3cf = new \DateTime(); $sp7be3cf = $sp7be3cf->sub(new \DateInterval('P08D')); $sp836266->weekBeforeValue = $this->getLeadsCountForForms($spc931e9, $sp7be3cf); $sp836266->textualWeekBeforeDay = $this->day[$sp7be3cf->format('N')] . ' ' . $sp7be3cf->format('d') . ' ' . $this->month[$sp7be3cf->format('n')]; $sp836266->yesterdayVariation = $this->getDeltaPourcent($sp836266->weekBeforeValue, $sp836266->yesterdayValue); $sp35c1ca = $sp836266->getRules(); if (empty($sp35c1ca)) { $sp3f766f = AlertUtils::$_STATUS_UNKNOWN; } else { $sp3f766f = $this->checkWarningStatus($sp836266->yesterdayValue, $sp836266->weekBeforeValue, $sp836266->getRules($sp35c1ca)); } $sp836266->yesterdayStatus = $sp3f766f; if ($sp3f766f == AlertUtils::$_STATUS_ERROR) { $sp836266->yesterdayStatusColor = 'pink'; $sp836266->yesterdayStatusText = 'Erreur'; } else { if ($sp3f766f == AlertUtils::$_STATUS_WARNING) { $sp836266->yesterdayStatusColor = 'yellow'; $sp836266->yesterdayStatusText = 'Attention!'; } else { if ($sp3f766f == AlertUtils::$_STATUS_UNKNOWN) { $sp836266->yesterdayStatusColor = 'black'; $sp836266->yesterdayStatusText = 'Aucune donnée'; } else { $sp836266->yesterdayStatusColor = 'green'; $sp836266->yesterdayStatusText = 'Status OK'; } } } } }